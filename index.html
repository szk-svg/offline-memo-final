<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>offline-memo-final</title>

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#111111">

<style>
:root{
  --bg:#fff; --card:#fff; --line:#e9e9e9; --text:#111; --muted:#777;
  --accent:#111; --danger:#d23b3b; --pill:#f4f4f4;
  --shadow:0 8px 24px rgba(0,0,0,.06);
  --r:16px; --tap:rgba(0,0,0,.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;background:var(--bg);color:var(--text)}

.topbar{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--line);padding:14px;z-index:30}
.brand{display:flex;align-items:center;justify-content:space-between;gap:12px}
.brand h1{margin:0;font-size:22px;font-weight:900}

.btn{border:1px solid var(--accent);background:#fff;color:var(--accent);
  border-radius:14px;padding:10px 14px;font-weight:900;font-size:14px}
.btn.primary{background:var(--accent);color:#fff}
.btn.ghost{border-color:var(--line)}
.btn.danger{border-color:#f2c0c0;color:var(--danger)}
.btn:active{background:var(--tap)}
.btn[disabled]{opacity:.45}

.container{padding:14px;max-width:980px;margin:0 auto}
.panel{background:var(--card);border:1px solid var(--line);border-radius:var(--r);
  box-shadow:var(--shadow);padding:14px}

.row{display:flex;gap:10px;align-items:center}
.spacer{flex:1}

.pill{background:var(--pill);border:1px solid var(--line);
  border-radius:999px;padding:8px 10px;font-size:12px;color:var(--muted);font-weight:900}
.muted{color:var(--muted);font-size:12px;font-weight:800}

.search{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);font-size:15px}

.list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
.sectionLabel{margin:10px 0 4px;font-weight:900;color:#444;font-size:14px;display:flex;gap:8px;align-items:center}

.rowCompact{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border:1px solid var(--line);
  border-radius:14px;background:#fff;
  user-select:none;-webkit-user-select:none;
}
.rowCompact.selected{outline:2px solid rgba(17,17,17,.45)}
.rowLeft{flex:1;min-width:0}
.rowTitle{font-weight:900;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rowMeta{font-size:12px;color:var(--muted);margin-top:2px;font-weight:800}
.rowActions{display:flex;gap:6px;align-items:center}

.miniBtn{
  width:36px;height:36px;border-radius:12px;
  border:1px solid var(--line);background:#fff;
  display:grid;place-items:center;font-size:15px;
  user-select:none;-webkit-user-select:none;touch-action:manipulation;
}
.miniBtn:active{background:var(--tap)}
.miniBtn.danger{border-color:#f2c0c0;color:var(--danger)}
.miniBtn.dim{opacity:.35}

.hidden{display:none!important}

/* editor */
.input{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);font-size:16px;font-weight:900}
.editor{
  border:1px solid var(--line);border-radius:16px;padding:12px;
  min-height:46vh;font-size:16px;line-height:1.6;background:#fff;
}
.editor{outline:none}

/* bottom toolbar (Aæ¡ˆ) */
.bottomBar{
  position:sticky;bottom:0;z-index:40;
  background:var(--bg);border-top:1px solid var(--line);
  padding:10px 14px;
}
.bottomBarInner{
  max-width:980px;margin:0 auto;
  display:flex;gap:8px;align-items:center;flex-wrap:wrap;
}
.tool{
  border:1px solid var(--line);border-radius:14px;padding:10px 12px;font-weight:900;
  background:#fff;font-size:13px;
}
.tool:active{background:var(--tap)}
.tool.active{border-color:var(--accent)}
.hint{margin-left:auto}

/* checkbox line */
.cbline{display:flex;gap:10px;margin:6px 0;align-items:flex-start}
.cbox{
  width:24px;height:24px;border:1px solid #bbb;border-radius:6px;
  display:grid;place-items:center;font-weight:900;flex:0 0 24px;
  user-select:none;-webkit-user-select:none;
}
.cbtext{flex:1;word-break:break-word}
.cbline.done .cbtext{color:#777;text-decoration:line-through}

/* plain line helper */
.plainline{min-height:1.2em}
.zwsp{user-select:none;-webkit-user-select:none}

/* toast */
.toast{
  position:fixed;left:50%;bottom:70px;transform:translateX(-50%);
  background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;
  border-radius:999px;font-weight:900;font-size:13px;
  opacity:0;transition:.2s;pointer-events:none;z-index:999;
}
.toast.show{opacity:1}

/* drag */
.dragging{opacity:.6}
.ghost{
  outline:2px dashed rgba(0,0,0,.25);
  border-radius:12px;height:56px;
}

/* modal */
.modalBg{
  position:fixed;inset:0;background:rgba(0,0,0,.35);
  display:none;align-items:flex-end;justify-content:center;
  z-index:1000;
}
.modalBg.show{display:flex}
.modal{
  width:min(980px, 100%);
  background:#fff;border-radius:18px 18px 0 0;
  border:1px solid var(--line);
  box-shadow:0 -12px 32px rgba(0,0,0,.12);
  padding:14px;
}
.modalTitle{font-weight:900;font-size:16px;margin:0 0 10px}
.modalBtns{display:flex;gap:10px;flex-wrap:wrap}
.modalBtns .btn{flex:1}
</style>
</head>

<body>
<div class="topbar">
  <div class="brand">
    <h1>offline-memo-final</h1>

    <!-- é€šå¸¸ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="topActionsNormal" class="row">
      <button id="btnExport" class="btn ghost" type="button">Export</button>
      <button id="btnImport" class="btn ghost" type="button">Import</button>
      <button id="btnNew" class="btn" type="button">æ–°è¦</button>
    </div>

    <!-- é¸æŠãƒ¢ãƒ¼ãƒ‰ -->
    <div id="topActionsSelect" class="row hidden">
      <div class="pill" id="selCountPill">é¸æŠ: 0</div>
      <button id="btnSelText" class="btn" type="button">ãƒ†ã‚­ã‚¹ãƒˆåŒ–</button>
      <button id="btnSelDelete" class="btn danger" type="button">å‰Šé™¤</button>
      <button id="btnSelCancel" class="btn ghost" type="button">è§£é™¤</button>
    </div>
  </div>
</div>

<div class="container">
  <!-- LIST -->
  <div id="screenList" class="panel">
    <div class="row">
      <div>
        <div style="font-size:20px;font-weight:900">ãƒ¡ãƒ¢ä¸€è¦§</div>
        <div class="muted">ï¼ˆç«¯æœ«å†…ã®ã¿ä¿å­˜ / é€šä¿¡ãªã—ï¼‰</div>
      </div>
      <div class="spacer"></div>
      <div id="countPill" class="pill">0ä»¶</div>
    </div>

    <input id="elSearch" class="search" placeholder="æ¤œç´¢ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»æœ¬æ–‡ï¼‰">

    <div class="muted" style="margin-top:10px">
      åŸºæœ¬ï¼šæ›´æ–°é † / â˜…å›ºå®šå†…ã‚‚æ›´æ–°é †å†…ã‚‚ â‰¡é•·æŠ¼ã—ã§ä¸¦ã³æ›¿ãˆï¼ˆæ¤œç´¢ä¸­ã¯ç„¡åŠ¹ï¼‰
      <br>â˜‘ ã‚’æŠ¼ã™ã¨è¤‡æ•°é¸æŠãƒ¢ãƒ¼ãƒ‰ï¼ˆå…¨è§£é™¤ã§è‡ªå‹•çµ‚äº†ï¼‰
    </div>

    <div id="notesEl" class="list"></div>
  </div>

  <!-- EDIT -->
  <div id="screenEdit" class="panel hidden">
    <div class="row" style="margin-bottom:10px">
      <button id="btnBack" class="btn" type="button">æˆ»ã‚‹</button>
      <div class="spacer"></div>
      <button id="btnUndo" class="btn ghost" type="button">â†¶</button>
      <button id="btnRedo" class="btn ghost" type="button">â†·</button>
      <button id="btnDeleteInEdit" class="btn danger" type="button">ğŸ—‘</button>
      <button id="btnSave" class="btn primary" type="button">ä¿å­˜</button>
    </div>

    <input id="elTitle" class="input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
    <div id="editor" class="editor" contenteditable="true" spellcheck="false" style="margin-top:10px"></div>

    <div class="muted" style="margin-top:10px">
      â€» ãƒã‚§ãƒƒã‚¯ã¯é–²è¦§/ç·¨é›†ã©ã¡ã‚‰ã§ã‚‚ON/OFFï¼ˆä¿å­˜ãƒœã‚¿ãƒ³æŠ¼ã™ã¾ã§æœªä¿å­˜ï¼‰
    </div>
  </div>
</div>

<!-- Bottom toolbar -->
<div id="bottomBar" class="bottomBar hidden">
  <div class="bottomBarInner">
    <button id="btnBlack" class="tool active" type="button">é»’</button>
    <button id="btnRed" class="tool" type="button">èµ¤</button>
    <button id="btnCb" class="tool" type="button">â˜‘ ãƒã‚§ãƒƒã‚¯åŒ–</button>
    <div class="spacer"></div>
    <div id="saveState" class="muted hint">ä¿å­˜æ¸ˆã¿</div>
  </div>
</div>

<input id="fileImport" type="file" class="hidden" multiple accept=".json,.txt,application/json,text/plain">
<div id="toast" class="toast">OK</div>

<!-- Export modal -->
<div id="exportModalBg" class="modalBg">
  <div class="modal">
    <div class="modalTitle">Export</div>
    <div class="muted" style="margin-bottom:10px">
      ãƒ»ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šå…¨ãƒ‡ãƒ¼ã‚¿ã‚’ .json<br>
      ãƒ»ãƒ†ã‚­ã‚¹ãƒˆåŒ–ï¼šé¸æŠä¸­ã®ãƒ¡ãƒ¢ â†’ 1ä»¶ãªã‚‰ .txt / è¤‡æ•°ãªã‚‰ .zip
    </div>
    <div class="modalBtns">
      <button id="btnDoBackup" class="btn primary" type="button">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ.jsonï¼‰</button>
      <button id="btnDoText" class="btn" type="button">ãƒ†ã‚­ã‚¹ãƒˆåŒ–ï¼ˆ.txt / .zipï¼‰</button>
      <button id="btnModalCancel" class="btn ghost" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<!-- Update modal -->
<div id="updateModalBg" class="modalBg">
  <div class="modal">
    <div class="modalTitle">æ›´æ–°ãŒã‚ã‚Šã¾ã™</div>
    <div class="muted" style="margin-bottom:10px">
      å†èµ·å‹•ã™ã‚‹ã¨æœ€æ–°ç‰ˆãŒåæ˜ ã•ã‚Œã¾ã™ï¼ˆæœªä¿å­˜ã¯æ¶ˆãˆã¾ã™ï¼‰ã€‚
    </div>
    <div class="modalBtns">
      <button id="btnReloadNow" class="btn primary" type="button">å†èµ·å‹•ã™ã‚‹</button>
      <button id="btnReloadLater" class="btn ghost" type="button">ã‚ã¨ã§</button>
    </div>
  </div>
</div>

<script>
/* =========================
   offline-memo-final v7 (backup1 stabilized)
   - cbline Enteræ ¹æ²»ï¼šbeforeinput + å…ˆé ­Enterä¾‹å¤–
   - cblineè§£é™¤ï¼šBackspace/Deleteï¼ˆGboardã¯beforeinputãŒæœ¬å‘½ï¼‰
   ========================= */

const STORAGE_KEY = "offline_memo_final_v7";
const ZWSP = "\u200B";

/* utils */
function nowTs(){ return Date.now(); }
function pad2(n){ return String(n).padStart(2,"0"); }
function fmt(ts){
  const d = new Date(ts);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}
function stampForFile(){
  const d = new Date();
  return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}${pad2(d.getSeconds())}`;
}
function uid(){
  return "n_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);
}
function safeParse(json, fallback){
  try{ return JSON.parse(json); }catch(_){ return fallback; }
}
function stripTags(html){
  const div = document.createElement("div");
  div.innerHTML = html || "";
  return (div.textContent || "").replace(/\s+/g," ").trim();
}
function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
function htmlToText(html){
  const div = document.createElement("div");
  div.innerHTML = html || "";
  div.querySelectorAll(".cbline").forEach(line=>{
    const done = line.getAttribute("data-done")==="true";
    const t = (line.querySelector(".cbtext")?.textContent || line.textContent || "").trim();
    line.replaceWith((done ? "â˜‘ " : "â˜ ") + t);
  });
  return (div.textContent || "").replace(/\u200B/g,"").replace(/\r/g,"").trim();
}

/* plainlineï¼ˆç©ºè¡Œã‚‚å¿…ãšã‚«ãƒ¼ã‚½ãƒ«ç½®ã‘ã‚‹å½¢ã«çµ±ä¸€ï¼‰ */
function makePlainLine(text=""){
  const div = document.createElement("div");
  div.className = "plainline";
  if (text && text.length){
    div.textContent = text;
  }else{
    div.innerHTML = `<span class="zwsp">${ZWSP}</span><br>`;
  }
  return div;
}

/* caret */
function setCaretToStart(el){
  const sel = window.getSelection();
  if (!sel) return;
  const r = document.createRange();
  r.selectNodeContents(el);
  r.collapse(true);
  sel.removeAllRanges();
  sel.addRange(r);
}
function setCaretToEnd(el){
  const sel = window.getSelection();
  if (!sel) return;
  const r = document.createRange();
  r.selectNodeContents(el);
  r.collapse(false);
  sel.removeAllRanges();
  sel.addRange(r);
}

/* toast */
const toastEl = document.getElementById("toast");
let toastTimer=null;
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>toastEl.classList.remove("show"), 1200);
}

/* DOM refs */
const screenList = document.getElementById("screenList");
const screenEdit = document.getElementById("screenEdit");
const bottomBar = document.getElementById("bottomBar");

const topActionsNormal = document.getElementById("topActionsNormal");
const topActionsSelect = document.getElementById("topActionsSelect");
const selCountPill = document.getElementById("selCountPill");
const btnSelDelete = document.getElementById("btnSelDelete");
const btnSelCancel = document.getElementById("btnSelCancel");
const btnSelText = document.getElementById("btnSelText");

const btnNew = document.getElementById("btnNew");
const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const fileImport = document.getElementById("fileImport");

const countPill = document.getElementById("countPill");
const elSearch = document.getElementById("elSearch");
const notesEl = document.getElementById("notesEl");

const btnBack = document.getElementById("btnBack");
const btnSave = document.getElementById("btnSave");
const btnDeleteInEdit = document.getElementById("btnDeleteInEdit");
const btnUndo = document.getElementById("btnUndo");
const btnRedo = document.getElementById("btnRedo");

const elTitle = document.getElementById("elTitle");
const editor = document.getElementById("editor");
const saveState = document.getElementById("saveState");
const btnBlack = document.getElementById("btnBlack");
const btnRed = document.getElementById("btnRed");
const btnCb = document.getElementById("btnCb");

/* modals */
const exportModalBg = document.getElementById("exportModalBg");
const btnDoBackup = document.getElementById("btnDoBackup");
const btnDoText = document.getElementById("btnDoText");
const btnModalCancel = document.getElementById("btnModalCancel");

const updateModalBg = document.getElementById("updateModalBg");
const btnReloadNow = document.getElementById("btnReloadNow");
const btnReloadLater = document.getElementById("btnReloadLater");
/* store */
function normalizeStore(s){
  if (!s || typeof s !== "object") s = {};
  if (!Array.isArray(s.notes)) s.notes = [];
  if (!Array.isArray(s.pinnedIds)) s.pinnedIds = [];
  if (!Array.isArray(s.normalOrderIds)) s.normalOrderIds = [];

  const t = nowTs();
  s.notes.forEach((n)=>{
    if (!n.id) n.id = uid();
    if (typeof n.title !== "string") n.title = "";
    if (typeof n.bodyHtml !== "string") n.bodyHtml = "";
    if (typeof n.createdAt !== "number") n.createdAt = t;
    if (typeof n.updatedAt !== "number") n.updatedAt = t;
  });

  const set = new Set(s.notes.map(n=>n.id));
  s.pinnedIds = s.pinnedIds.filter(id=>set.has(id));
  s.normalOrderIds = s.normalOrderIds.filter(id=>set.has(id) && !s.pinnedIds.includes(id));

  if (s.normalOrderIds.length === 0){
    s.normalOrderIds = s.notes
      .filter(n=>!s.pinnedIds.includes(n.id))
      .sort((a,b)=>b.updatedAt-a.updatedAt)
      .map(n=>n.id);
  }
  return s;
}
function loadStore(){
  const raw = localStorage.getItem(STORAGE_KEY);
  return normalizeStore(safeParse(raw, {notes:[], pinnedIds:[], normalOrderIds:[]}));
}
function saveStore(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
}
let store = loadStore();

function getNote(id){ return store.notes.find(n=>n.id===id) || null; }
function ensureAtLeastOne(){
  if (store.notes.length) return;
  const n = { id: uid(), title:"", bodyHtml:"", createdAt: nowTs(), updatedAt: nowTs() };
  store.notes.push(n);
  store.normalOrderIds = [n.id];
  saveStore();
}
function isPinned(id){ return store.pinnedIds.includes(id); }
function pinToggle(id){
  if (isPinned(id)){
    store.pinnedIds = store.pinnedIds.filter(x=>x!==id);
    store.normalOrderIds = store.normalOrderIds.filter(x=>x!==id);
    store.normalOrderIds.unshift(id);
  }else{
    store.normalOrderIds = store.normalOrderIds.filter(x=>x!==id);
    store.pinnedIds = store.pinnedIds.filter(x=>x!==id);
    store.pinnedIds.unshift(id);
  }
}

/* selection mode */
let selectionMode = false;
let selectedIds = new Set();

function updateTopActions(){
  if (selectionMode){
    topActionsNormal.classList.add("hidden");
    topActionsSelect.classList.remove("hidden");
    selCountPill.textContent = `é¸æŠ: ${selectedIds.size}`;
    btnSelDelete.disabled = selectedIds.size === 0;
    btnSelText.disabled = selectedIds.size === 0;
  }else{
    topActionsSelect.classList.add("hidden");
    topActionsNormal.classList.remove("hidden");
  }
}

function setSelectionMode(on){
  selectionMode = !!on;
  if (!selectionMode) selectedIds.clear();
  updateTopActions();
  renderList();
}

function toggleSelected(id){
  if (!selectionMode) selectionMode = true;

  if (selectedIds.has(id)) selectedIds.delete(id);
  else selectedIds.add(id);

  if (selectedIds.size === 0){
    selectionMode = false;
  }
  updateTopActions();
  renderList();
}

btnSelCancel.addEventListener("click", ()=> setSelectionMode(false));
btnSelDelete.addEventListener("click", ()=>{
  if (selectedIds.size === 0) return;
  deleteNotes(Array.from(selectedIds));
});

/* UI state */
let currentId=null;
let dirty=false;
let savedTitle="", savedHtml="";
let draftTitle="", draftHtml="";
let openedByNew=false;

/* dirty */
function updateDirtyFlag(){
  dirty = (draftTitle !== savedTitle) || (draftHtml !== savedHtml);
  saveState.textContent = dirty ? "æœªä¿å­˜" : "ä¿å­˜æ¸ˆã¿";
}

/* screen */
function showList(){
  screenEdit.classList.add("hidden");
  bottomBar.classList.add("hidden");
  screenList.classList.remove("hidden");

  currentId = null;
  dirty = false;
  openedByNew = false;

  renderList();
  history.replaceState({screen:"list"}, "");
}

/* heading */
function addHeadingToFrag(frag, text){
  const lab = document.createElement("div");
  lab.className = "sectionLabel";
  lab.textContent = text;
  frag.appendChild(lab);
}

/* list builder */
function buildList(){
  const q = (elSearch.value||"").trim().toLowerCase();
  const notes = store.notes.slice();
  const byId = new Map(notes.map(n=>[n.id,n]));

  let pinned = store.pinnedIds.map(id=>byId.get(id)).filter(Boolean);
  let normalIds = store.normalOrderIds.filter(id=>!store.pinnedIds.includes(id) && byId.has(id));
  let normal = normalIds.map(id=>byId.get(id)).filter(Boolean);

  if (q){
    const filtered = notes.filter(n=>{
      const t = (n.title||"").toLowerCase();
      const b = stripTags(n.bodyHtml||"").toLowerCase();
      return t.includes(q) || b.includes(q);
    });
    const filteredSet = new Set(filtered.map(n=>n.id));
    pinned = pinned.filter(n=>filteredSet.has(n.id));
    normal = filtered.filter(n=>!store.pinnedIds.includes(n.id)).sort((a,b)=>b.updatedAt-a.updatedAt);
    return { pinned, normal, searching:true };
  }
  return { pinned, normal, searching:false };
}

/* row */
function renderRow(note, searching){
  const row = document.createElement("div");
  row.className = "rowCompact";
  row.dataset.id = note.id;
  if (selectedIds.has(note.id)) row.classList.add("selected");

  const left = document.createElement("div");
  left.className = "rowLeft";

  const title = document.createElement("div");
  title.className = "rowTitle";
  title.textContent = (note.title||"").trim() ? note.title : "ï¼ˆç„¡é¡Œï¼‰";

  const meta = document.createElement("div");
  meta.className = "rowMeta";
  meta.textContent = `æ›´æ–°: ${fmt(note.updatedAt)}`;

  left.append(title, meta);

  const actions = document.createElement("div");
  actions.className = "rowActions";

  const selBtn = document.createElement("button");
  selBtn.className = "miniBtn";
  selBtn.type="button";
  selBtn.textContent = selectedIds.has(note.id) ? "â˜‘" : "â˜";
  selBtn.title = "è¤‡æ•°é¸æŠ";

  const dragBtn = document.createElement("button");
  dragBtn.className = "miniBtn";
  dragBtn.type="button";
  dragBtn.textContent = "â‰¡";
  dragBtn.title = "é•·æŠ¼ã—ã§ä¸¦ã³æ›¿ãˆ";

  const starBtn = document.createElement("button");
  starBtn.className = "miniBtn";
  starBtn.type="button";
  starBtn.textContent = isPinned(note.id) ? "â˜…" : "â˜†";
  starBtn.title = "å›ºå®š";

  const delBtn = document.createElement("button");
  delBtn.className = "miniBtn danger";
  delBtn.type="button";
  delBtn.textContent = "ğŸ—‘";
  delBtn.title = "å‰Šé™¤";

  actions.append(selBtn, dragBtn, starBtn, delBtn);
  row.append(left, actions);

  row.addEventListener("click", ()=>{
    if (selectionMode){
      toggleSelected(note.id);
      return;
    }
    openNote(note.id, false);
  });

  selBtn.addEventListener("click", (e)=>{
    e.stopPropagation();
    toggleSelected(note.id);
  });

  starBtn.addEventListener("click", (e)=>{
    e.stopPropagation();
    pinToggle(note.id);
    saveStore();
    renderList();
    toast(isPinned(note.id) ? "å›ºå®šã—ã¾ã—ãŸ" : "å›ºå®šã‚’è§£é™¤ã—ã¾ã—ãŸ");
  });

  delBtn.addEventListener("click", (e)=>{
    e.stopPropagation();
    if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    deleteNotes([note.id]);
  });

  if (!searching && !selectionMode){
    attachManualDrag(dragBtn, row, note);
  }else{
    dragBtn.classList.add("dim");
  }

  return row;
}
/* render list */
function renderList(){
  countPill.textContent = `${store.notes.length}ä»¶`;

  const { pinned, normal, searching } = buildList();
  notesEl.innerHTML = "";

  const frag = document.createDocumentFragment();

  if (pinned.length){
    addHeadingToFrag(frag, "â˜… å›ºå®š");
    pinned.forEach(n=> frag.appendChild(renderRow(n, searching)));
  }
  addHeadingToFrag(frag, "æ›´æ–°é †");

  if (!normal.length){
    const m = document.createElement("div");
    m.className = "muted";
    m.style.padding = "6px 2px";
    m.textContent = searching ? "ä¸€è‡´ã™ã‚‹ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“" : "ãƒ¡ãƒ¢ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå³ä¸Šã®æ–°è¦ã‹ã‚‰ä½œæˆï¼‰";
    frag.appendChild(m);
  }else{
    normal.forEach(n=> frag.appendChild(renderRow(n, searching)));
  }

  notesEl.appendChild(frag);
  updateTopActions();
}

/* open */
function openNote(id, isNew){
  const note = getNote(id);
  if (!note){ toast("ãƒ¡ãƒ¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); return; }

  currentId = id;
  openedByNew = !!isNew;

  draftTitle = note.title || "";
  draftHtml  = note.bodyHtml || "";
  savedTitle = draftTitle;
  savedHtml  = draftHtml;

  elTitle.value = draftTitle;
  editor.innerHTML = draftHtml || "";
  normalizeCbLines(editor);

  screenList.classList.add("hidden");
  screenEdit.classList.remove("hidden");
  bottomBar.classList.remove("hidden");

  resetUndoRedo();
  updateDirtyFlag();

  if (openedByNew) setTimeout(()=> elTitle.focus(), 0);
  else setTimeout(()=> editor.focus(), 0);

  history.pushState({screen:"edit", id: currentId}, "");
}

/* delete helper */
function deleteNotes(ids){
  const uniq = Array.from(new Set(ids)).filter(Boolean);
  if (!uniq.length) return;

  if (uniq.length >= 2){
    if (!confirm(`${uniq.length}ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  }

  store.notes = store.notes.filter(n=>!uniq.includes(n.id));
  store.pinnedIds = store.pinnedIds.filter(id=>!uniq.includes(id));
  store.normalOrderIds = store.normalOrderIds.filter(id=>!uniq.includes(id));
  ensureAtLeastOne();
  saveStore();

  selectionMode = false;
  selectedIds.clear();
  updateTopActions();

  renderList();
  toast("å‰Šé™¤ã—ã¾ã—ãŸ");
}

/* list events */
elSearch.addEventListener("input", ()=> renderList());

btnNew.addEventListener("click", ()=>{
  const n = { id: uid(), title:"", bodyHtml:"", createdAt: nowTs(), updatedAt: nowTs() };
  store.notes.unshift(n);

  store.normalOrderIds = store.normalOrderIds.filter(x=>x!==n.id);
  store.normalOrderIds.unshift(n.id);

  saveStore();
  renderList();
  openNote(n.id, true);

  draftTitle = "";
  draftHtml = "";
  savedTitle = "";
  savedHtml = "";
  elTitle.value = "";
  editor.innerHTML = "";
  updateDirtyFlag();
  resetUndoRedo();
});

/* =========================
   editor / checkbox / undo / save
   ========================= */

function cleanHtml(html){
  // stray <div><br></div> ã‚’ plainlineã«çµ±ä¸€ï¼ˆå¼·ã‚ï¼‰
  const safe = (html||"");
  return safe
    .replace(/<div><br><\/div>/gi, `<div class="plainline"><span class="zwsp">${ZWSP}<\/span><br><\/div>`)
    .replace(/<div class="plainline"><br><\/div>/gi, `<div class="plainline"><span class="zwsp">${ZWSP}<\/span><br><\/div>`)
    .replace(/<div class="plainline">\u200B<\/div>/g, `<div class="plainline"><span class="zwsp">${ZWSP}<\/span><br><\/div>`);
}

/* checkbox helpers */
function normalizeCbLines(root){
  root.querySelectorAll(".cbline").forEach(line=>{
    const done = line.getAttribute("data-done") === "true";
    line.classList.toggle("done", done);
    const box = line.querySelector(".cbox");
    if (box) box.textContent = done ? "â˜‘" : "â˜";
  });
}
function toggleCbLine(line){
  const done = line.getAttribute("data-done") === "true";
  const next = !done;
  line.setAttribute("data-done", next ? "true" : "false");
  line.classList.toggle("done", next);
  const box = line.querySelector(".cbox");
  if (box) box.textContent = next ? "â˜‘" : "â˜";
}

/* sync draft */
function syncDraftFromCurrent(){
  draftTitle = elTitle.value || "";
  draftHtml = cleanHtml(editor.innerHTML);
  editor.innerHTML = draftHtml;
  normalizeCbLines(editor);
  updateDirtyFlag();
}

/* Undo/Redo */
let undoStack = [];
let redoStack = [];
const UNDO_LIMIT = 80;
let pushTimer = null;

function refreshUndoButtons(){
  btnUndo.disabled = undoStack.length <= 1;
  btnRedo.disabled = redoStack.length === 0;
}
function pushUndoSnapshot(){
  const snap = { title: (elTitle.value||""), html: cleanHtml(editor.innerHTML) };
  const last = undoStack[undoStack.length-1];
  if (last && last.title===snap.title && last.html===snap.html) return;
  undoStack.push(snap);
  if (undoStack.length > UNDO_LIMIT) undoStack.shift();
  redoStack = [];
  refreshUndoButtons();
}
function schedulePushSnapshot(){
  clearTimeout(pushTimer);
  pushTimer = setTimeout(()=> pushUndoSnapshot(), 200);
}
function resetUndoRedo(){
  undoStack = [];
  redoStack = [];
  undoStack.push({title:(elTitle.value||""), html: cleanHtml(editor.innerHTML)});
  refreshUndoButtons();
}

btnUndo.addEventListener("click", ()=>{
  if (undoStack.length <= 1) return;
  redoStack.push({ title:(elTitle.value||""), html: cleanHtml(editor.innerHTML) });
  undoStack.pop();
  const prev = undoStack[undoStack.length-1];

  draftTitle = prev.title;
  draftHtml  = prev.html;

  elTitle.value = draftTitle;
  editor.innerHTML = draftHtml;
  normalizeCbLines(editor);

  updateDirtyFlag();
  refreshUndoButtons();
});
btnRedo.addEventListener("click", ()=>{
  if (redoStack.length === 0) return;
  const next = redoStack.pop();
  undoStack.push({ title: next.title, html: next.html });
  if (undoStack.length > UNDO_LIMIT) undoStack.shift();

  draftTitle = next.title;
  draftHtml  = next.html;

  elTitle.value = draftTitle;
  editor.innerHTML = draftHtml;
  normalizeCbLines(editor);

  updateDirtyFlag();
  refreshUndoButtons();
});

/* checkbox click */
editor.addEventListener("click", (e)=>{
  const box = e.target.closest && e.target.closest(".cbox");
  const line = e.target.closest && e.target.closest(".cbline");
  if (line && box){
    pushUndoSnapshot();
    toggleCbLine(line);
    draftHtml = cleanHtml(editor.innerHTML);
    updateDirtyFlag();
    schedulePushSnapshot();
  }
});

/* ---- Enter æ ¹æ²» + Backspace/Deleteã§ãƒã‚§ãƒƒã‚¯è§£é™¤ï¼ˆGboardå¯¾ç­–è¾¼ã¿ï¼‰ ---- */
function getCaretOffsetInElement(el){
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return null;
  const range = sel.getRangeAt(0);
  if (!el.contains(range.startContainer)) return null;

  const pre = range.cloneRange();
  pre.selectNodeContents(el);
  pre.setEnd(range.startContainer, range.startOffset);
  return pre.toString().length;
}

function getPrevElementSibling(node){
  let p = node ? node.previousSibling : null;
  while (p && p.nodeType !== 1) p = p.previousSibling;
  return p && p.nodeType === 1 ? p : null;
}

function isPlainlineEffectivelyEmpty(pl){
  const t = (pl.textContent || "").replaceAll(ZWSP,"").trim();
  return t.length === 0;
}

function isCaretAtStartOfElement(el){
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return false;
  const range = sel.getRangeAt(0);
  if (!sel.isCollapsed) return false;
  if (!el.contains(range.startContainer)) return false;

  const pre = range.cloneRange();
  pre.selectNodeContents(el);
  pre.setEnd(range.startContainer, range.startOffset);
  const s = pre.toString().replaceAll(ZWSP,"");
  return s.length === 0;
}

function cblineToPlainline(cbline){
  const cbtext = cbline.querySelector(".cbtext");
  const text = (cbtext?.textContent || "").replaceAll(ZWSP,"");
  const pl = makePlainLine(text.trim() ? text : "");
  cbline.replaceWith(pl);
  setTimeout(()=>setCaretToStart(pl),0);
}

/* Enterï¼šcblineå†…ã ã‘è‡ªå‰ã§åˆ†å‰² */
function handleEnterInsideCbline(){
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return false;
  if (!sel.isCollapsed) return false;

  const range = sel.getRangeAt(0);
  let node = range.startContainer;
  if (!node) return false;
  if (node.nodeType === 3) node = node.parentNode;

  const cbline = node?.closest?.(".cbline");
  if (!cbline) return false;

  const cbtext = cbline.querySelector(".cbtext");
  pushUndoSnapshot();

  if (!cbtext){
    const pl = makePlainLine("");
    cbline.after(pl);
    setTimeout(()=>setCaretToStart(pl),0);
    draftHtml = cleanHtml(editor.innerHTML);
    updateDirtyFlag();
    schedulePushSnapshot();
    return true;
  }

  const full = cbtext.textContent || "";
  let caret = null;
  try{ caret = getCaretOffsetInElement(cbtext); }catch(_){ caret = null; }
  const cut = (caret == null) ? full.length : Math.max(0, Math.min(caret, full.length));

  /* â˜…å…ˆé ­Enterï¼šç©ºã®cblineã‚’ä½œã‚‰ãšã€ä¸Šã«plainlineã‚’ä½œã‚‹ */
  if (cut === 0){
    const plUp = makePlainLine("");
    cbline.before(plUp);
    setTimeout(()=>setCaretToStart(plUp),0);

    draftHtml = cleanHtml(editor.innerHTML);
    updateDirtyFlag();
    schedulePushSnapshot();
    return true;
  }

  const left = full.slice(0, cut);
  const right = full.slice(cut);

  cbtext.textContent = left;

  const pl = makePlainLine(right);
  cbline.after(pl);
  setTimeout(()=>setCaretToStart(pl),0);

  draftHtml = cleanHtml(editor.innerHTML);
  updateDirtyFlag();
  schedulePushSnapshot();
  return true;
}

/* Backspace/Deleteï¼šcblineå…ˆé ­ or ã€Œcblineç›´å¾Œã®ç©ºè¡Œå…ˆé ­ã€ãªã‚‰ãƒã‚§ãƒƒã‚¯è§£é™¤ */
function handleBackspaceDeleteAroundCbline(kind /* "Backspace" | "Delete" */){
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return false;
  if (!sel.isCollapsed) return false;

  const range = sel.getRangeAt(0);
  let node = range.startContainer;
  if (!node) return false;
  if (node.nodeType === 3) node = node.parentNode;

  const cbline = node?.closest?.(".cbline");
  if (cbline){
    const cbtext = cbline.querySelector(".cbtext");
    if (!cbtext) return false;

    let caret = null;
    try{ caret = getCaretOffsetInElement(cbtext); }catch(_){ caret = null; }
    const atStart = (caret == null) ? true : (caret === 0);

    if (atStart && (kind === "Backspace" || kind === "Delete")){
      pushUndoSnapshot();
      cblineToPlainline(cbline);
      draftHtml = cleanHtml(editor.innerHTML);
      updateDirtyFlag();
      schedulePushSnapshot();
      return true;
    }
    return false;
  }

  /* â˜…ã“ã“ãŒä»Šå›ã®æœ¬å‘½ï¼šãƒã‚§ãƒƒã‚¯åŒ–ç›´å¾Œã¯ã€Œcblineã®æ¬¡ã®plainlineã€ã«å±…ã‚‹ã“ã¨ãŒå¤šã„ */
  const pl = node?.closest?.(".plainline");
  if (!pl) return false;

  if (!isCaretAtStartOfElement(pl)) return false;

  const prev = getPrevElementSibling(pl);
  if (!prev || !prev.classList?.contains("cbline")) return false;

  pushUndoSnapshot();

  /* ç©ºã®plainlineãªã‚‰æ¶ˆã—ã¦ã‹ã‚‰ãƒã‚§ãƒƒã‚¯è§£é™¤ï¼ˆä½™è¨ˆãªç©ºç™½ãŒæ®‹ã‚‰ãªã„ï¼‰ */
  if (isPlainlineEffectivelyEmpty(pl)) pl.remove();

  cblineToPlainline(prev);

  draftHtml = cleanHtml(editor.innerHTML);
  updateDirtyFlag();
  schedulePushSnapshot();
  return true;
}

/* â˜…beforeinputï¼šAndroid(Gboard)ã¯ã“ã“ãŒæœ¬å‘½ */
editor.addEventListener("beforeinput", (e)=>{
  const t = e.inputType || "";
  const data = (typeof e.data === "string") ? e.data : "";

  const looksLikeEnter =
    t === "insertParagraph" ||
    t === "insertLineBreak" ||
    (t === "insertText" && (data === "\n" || data === "\r" || data === "\r\n")) ||
    ((t === "insertCompositionText" || t === "insertFromComposition") &&
      (data.includes("\n") || data.includes("\r")));

  if (looksLikeEnter){
    const handled = handleEnterInsideCbline();
    if (handled){
      e.preventDefault();
      e.stopPropagation();
    }
    return;
  }

  if (t === "deleteContentBackward"){
    const handled = handleBackspaceDeleteAroundCbline("Backspace");
    if (handled){
      e.preventDefault();
      e.stopPropagation();
    }
    return;
  }

  if (t === "deleteContentForward"){
    const handled = handleBackspaceDeleteAroundCbline("Delete");
    if (handled){
      e.preventDefault();
      e.stopPropagation();
    }
    return;
  }
});

/* keydownï¼šç«¯æœ«ã«ã‚ˆã£ã¦ã¯æ¥ã‚‹ã®ã§ä¿é™º */
editor.addEventListener("keydown", (e)=>{
  if (e.key === "Enter"){
    const handled = handleEnterInsideCbline();
    if (handled){
      e.preventDefault();
      e.stopPropagation();
      return;
    }
  }
  if (e.key === "Backspace" || e.key === "Delete"){
    const handled = handleBackspaceDeleteAroundCbline(e.key);
    if (handled){
      e.preventDefault();
      e.stopPropagation();
      return;
    }
  }
});

/* input */
editor.addEventListener("input", ()=>{
  // AndroidãŒå‹æ‰‹ã«ç©ºdiv/brã‚’æ··ãœãŸã‚‰ plainline ã«å›å
  editor.querySelectorAll(".cbline").forEach(line=>{
    const next = line.nextSibling;
    if (next && next.nodeType === 1){
      const el = next;
      if (el.tagName === "DIV" && !el.classList.contains("plainline") && !el.classList.contains("cbline")){
        const html = (el.innerHTML || "").toLowerCase().replace(/\s/g,"");
        if (html === "<br>" || html === "<br/>" || html === ""){
          const pl = makePlainLine("");
          el.replaceWith(pl);
        }
      }
    }
  });

  draftHtml = cleanHtml(editor.innerHTML);
  updateDirtyFlag();
  schedulePushSnapshot();
});
elTitle.addEventListener("input", ()=>{
  draftTitle = elTitle.value || "";
  updateDirtyFlag();
  schedulePushSnapshot();
});

/* color */
function applyColor(color){
  pushUndoSnapshot();
  editor.focus();
  try{ document.execCommand("styleWithCSS", false, true); }catch(_){}
  document.execCommand("foreColor", false, color);

  draftHtml = cleanHtml(editor.innerHTML);
  updateDirtyFlag();
  schedulePushSnapshot();
}
btnBlack.addEventListener("click", ()=>{
  btnBlack.classList.add("active");
  btnRed.classList.remove("active");
  applyColor("#111111");
});
btnRed.addEventListener("click", ()=>{
  btnRed.classList.add("active");
  btnBlack.classList.remove("active");
  applyColor("#d23b3b");
});

/* è¡Œå–å¾— */
function getCurrentBlockInEditor(){
  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0) return null;
  const range = sel.getRangeAt(0);

  let node = range.startContainer;
  if (!node) return null;

  if (node.nodeType === 3){
    const parent = node.parentNode;
    if (parent === editor){
      const wrap = document.createElement("div");
      editor.insertBefore(wrap, node);
      wrap.appendChild(node);
      return wrap;
    }
    node = parent;
  }

  const pl = node.closest?.(".plainline");
  if (pl) return pl;

  const cb = node.closest?.(".cbline");
  if (cb) return cb;

  while (node && node !== editor){
    const tag = (node.tagName||"").toUpperCase();
    if (tag === "DIV" || tag === "P" || tag === "LI") return node;
    node = node.parentNode;
  }
  return null;
}

/* checkbox buttonï¼šé¸æŠ or è¡Œ */
btnCb.addEventListener("click", ()=>{
  editor.focus();

  const sel = window.getSelection();
  if (!sel || sel.rangeCount === 0){
    toast("æ–‡å­—ã‚’é¸æŠã™ã‚‹ã‹ã€è¡Œã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç½®ã„ã¦æŠ¼ã—ã¦ã­");
    return;
  }

  const range = sel.getRangeAt(0);
  if (!editor.contains(range.commonAncestorContainer)){
    toast("æœ¬æ–‡å†…ã§æ“ä½œã—ã¦ã­");
    return;
  }

  const makeLine = (text)=>{
    const line = document.createElement("div");
    line.className = "cbline";
    line.setAttribute("data-done","false");

    const box = document.createElement("span");
    box.className = "cbox";
    box.textContent = "â˜";
    box.contentEditable = "false";

    const span = document.createElement("span");
    span.className = "cbtext";
    span.textContent = text;

    line.appendChild(box);
    line.appendChild(span);
    return line;
  };

  const focusToPlainlineStart = (pl)=>{
    // Gboardã¯ã€Œç›´å¾Œã®1æ‰“ã€ã§ã‚­ãƒ£ãƒ¬ãƒƒãƒˆãŒã‚ºãƒ¬ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€è¤‡æ•°å›å›ºå®šã™ã‚‹
    const fix = ()=>{
      editor.focus();
      setCaretToStart(pl);
    };
    fix();
    setTimeout(fix, 0);
    requestAnimationFrame(fix);
    setTimeout(fix, 40);
  };

  const selectedText = sel.toString().trim();
  pushUndoSnapshot();

  if (selectedText){
    // é¸æŠãƒ†ã‚­ã‚¹ãƒˆ â†’ cblineåŒ–
    const line = makeLine(selectedText);
    range.deleteContents();
    range.insertNode(line);

    // æ¬¡è¡Œã‚’å¿…ãš plainline ã«ã—ã¦ã€ãã“ã¸ã‚­ãƒ£ãƒ¬ãƒƒãƒˆ
    const pl = makePlainLine("");
    line.after(pl);

    sel.removeAllRanges();
    const r2 = document.createRange();
    r2.selectNodeContents(pl);
    r2.collapse(true);
    sel.addRange(r2);

    focusToPlainlineStart(pl);

  }else{
    // ã‚«ãƒ¼ã‚½ãƒ«è¡Œ â†’ cblineåŒ– or æ—¢å­˜cblineãªã‚‰ãƒˆã‚°ãƒ«
    const block = getCurrentBlockInEditor();
    if (!block){
      toast("è¡Œã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç½®ã„ã¦æŠ¼ã—ã¦ã­");
      return;
    }

    if (block.classList?.contains("cbline")){
      toggleCbLine(block);
      draftHtml = cleanHtml(editor.innerHTML);
      updateDirtyFlag();
      schedulePushSnapshot();
      return;
    }

    const text = (block.textContent||"").replaceAll(ZWSP,"").trim();
    if (!text){
      toast("ç©ºã®è¡Œã¯ãƒã‚§ãƒƒã‚¯åŒ–ã§ããªã„ã‚ˆ");
      return;
    }

    const line = makeLine(text);
    block.replaceWith(line);

    // â˜…ã“ã“ãŒå¤§äº‹ï¼šè¡Œç½®æ›ãƒ«ãƒ¼ãƒˆã§ã‚‚ã€Œæ¬¡è¡Œplainlineã€ã‚’ä½œã£ã¦ã‚­ãƒ£ãƒ¬ãƒƒãƒˆã‚’é€ƒãŒã™
    const pl = makePlainLine("");
    line.after(pl);
    focusToPlainlineStart(pl);
  }

  draftHtml = cleanHtml(editor.innerHTML);
  normalizeCbLines(editor);
  updateDirtyFlag();
  schedulePushSnapshot();
});

/* save/back/delete */
function confirmDiscardIfDirty(){
  if (!dirty) return true;
  return confirm("æ›´æ–°ã¯ç ´æ£„ã•ã‚Œã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
}
function saveCurrent(){
  const note = getNote(currentId);
  if (!note) return;

  syncDraftFromCurrent();

  note.title = draftTitle;
  note.bodyHtml = draftHtml;
  note.updatedAt = nowTs();

  if (!isPinned(note.id)){
    store.normalOrderIds = store.normalOrderIds.filter(x=>x!==note.id);
    store.normalOrderIds.unshift(note.id);
  }

  saveStore();

  savedTitle = draftTitle;
  savedHtml  = draftHtml;
  updateDirtyFlag();

  toast("ä¿å­˜ã—ã¾ã—ãŸ");
  resetUndoRedo();
}

btnSave.addEventListener("click", ()=> saveCurrent());
btnBack.addEventListener("click", ()=>{
  if (!confirmDiscardIfDirty()) return;
  showList();
});
btnDeleteInEdit.addEventListener("click", ()=>{
  const note = getNote(currentId);
  if (!note) return;
  const name = (note.title||"").trim() ? note.title : "ï¼ˆç„¡é¡Œï¼‰";
  if (!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  deleteNotes([note.id]);
  showList();
});

/* =========================
   Export/Import + ZIP + Drag + SW update + boot
   ========================= */

/* Export modal */
function openExportModal(){ exportModalBg.classList.add("show"); }
function closeExportModal(){ exportModalBg.classList.remove("show"); }
btnExport.addEventListener("click", ()=>{
  if (!screenEdit.classList.contains("hidden") && dirty){
    const ok = confirm("ç·¨é›†ä¸­ã®æœªä¿å­˜å†…å®¹ãŒã‚ã‚Šã¾ã™ã€‚\nä¿å­˜ã›ãšã«Exportã™ã‚‹ã¨æœªä¿å­˜åˆ†ã¯å…¥ã‚Šã¾ã›ã‚“ã€‚\nç¶šã‘ã¾ã™ã‹ï¼Ÿ");
    if (!ok) return;
  }
  openExportModal();
});
btnModalCancel.addEventListener("click", ()=> closeExportModal());
exportModalBg.addEventListener("click", (e)=>{ if (e.target === exportModalBg) closeExportModal(); });

/* backup json */
btnDoBackup.addEventListener("click", ()=>{
  closeExportModal();
  const payload = { version: 1, exportedAt: nowTs(), data: store };
  const json = JSON.stringify(payload, null, 2);
  const blob = new Blob([json], {type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `offline-memo-backup-${stampForFile()}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();

  setTimeout(()=> URL.revokeObjectURL(url), 800);
  toast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ");
});

/* ---- ZIPï¼ˆstoreï¼‰ ---- */
function crc32Table(){
  const table = new Uint32Array(256);
  for (let i=0;i<256;i++){
    let c=i;
    for (let k=0;k<8;k++){
      c = (c & 1) ? (0xEDB88320 ^ (c>>>1)) : (c>>>1);
    }
    table[i]=c>>>0;
  }
  return table;
}
const CRC_TABLE = crc32Table();

function crc32(u8){
  let c = 0xFFFFFFFF;
  for (let i=0;i<u8.length;i++){
    c = CRC_TABLE[(c ^ u8[i]) & 0xFF] ^ (c>>>8);
  }
  return (c ^ 0xFFFFFFFF)>>>0;
}
function u16(n){ return new Uint8Array([n & 255, (n>>>8)&255]); }
function u32(n){ return new Uint8Array([n & 255, (n>>>8)&255, (n>>>16)&255, (n>>>24)&255]); }
function concat(chunks){
  const total = chunks.reduce((s,c)=>s + c.length, 0);
  const out = new Uint8Array(total);
  let o=0;
  for (const c of chunks){ out.set(c, o); o+=c.length; }
  return out;
}
function strU8(s){ return new TextEncoder().encode(s); }

function zipStore(files){
  const locals = [];
  const centrals = [];
  let offset = 0;

  for (const f of files){
    const nameU8 = strU8(f.name);
    const dataU8 = f.data;
    const crc = crc32(dataU8);
    const size = dataU8.length;

    const local = concat([
      u32(0x04034b50),
      u16(20),
      u16(0),
      u16(0),
      u16(0), u16(0),
      u32(crc),
      u32(size),
      u32(size),
      u16(nameU8.length),
      u16(0),
      nameU8,
      dataU8
    ]);
    locals.push(local);

    const central = concat([
      u32(0x02014b50),
      u16(20), u16(20),
      u16(0),
      u16(0),
      u16(0), u16(0),
      u32(crc),
      u32(size),
      u32(size),
      u16(nameU8.length),
      u16(0), u16(0),
      u16(0), u16(0),
      u32(0),
      u32(offset),
      nameU8
    ]);
    centrals.push(central);

    offset += local.length;
  }

  const centralStart = offset;
  const centralData = concat(centrals);

  const end = concat([
    u32(0x06054b50),
    u16(0), u16(0),
    u16(files.length),
    u16(files.length),
    u32(centralData.length),
    u32(centralStart),
    u16(0)
  ]);

  return concat([...locals, centralData, end]);
}

/* filename helpers */
function sanitizeFileName(name){
  return (name||"").replace(/[\\\/:*?"<>|]/g, "_").trim();
}
function buildUniqueNames(notes){
  const counts = new Map();
  const out = [];
  for (const n of notes){
    const baseRaw = (n.title||"").trim() ? n.title.trim() : "ç„¡é¡Œ";
    const base = sanitizeFileName(baseRaw) || "ç„¡é¡Œ";
    const key = base.toLowerCase();
    const c = (counts.get(key) || 0) + 1;
    counts.set(key, c);
    out.push(c === 1 ? base : `${base}${c}`);
  }
  return out;
}

/* text exportï¼ˆé–¢æ•°åŒ–ï¼‰ */
function doTextExport(){
  if (!selectionMode || selectedIds.size === 0){
    toast("ãƒ†ã‚­ã‚¹ãƒˆåŒ–ã™ã‚‹ãƒ¡ãƒ¢ã‚’ â˜‘ ã§é¸ã‚“ã§ã­");
    return;
  }

  const ids = Array.from(selectedIds);
  const notes = ids.map(id=>getNote(id)).filter(Boolean);
  if (!notes.length){
    setSelectionMode(false);
    toast("é¸æŠãŒç©ºã§ã™");
    return;
  }

  const names = buildUniqueNames(notes);

  if (notes.length === 1){
    const text = htmlToText(notes[0].bodyHtml);
    const blob = new Blob([text], {type:"text/plain"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `${names[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 800);

    toast("ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ");
    setSelectionMode(false);
    return;
  }

  const files = notes.map((n,i)=>({
    name: `${names[i]}.txt`,
    data: strU8(htmlToText(n.bodyHtml))
  }));

  const zipU8 = zipStore(files);
  const blob = new Blob([zipU8], {type:"application/zip"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `offline-memo-text-${stampForFile()}.zip`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1200);

  toast("ZIPã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ");
  setSelectionMode(false);
}

/* modalå†…ã®ãƒ†ã‚­ã‚¹ãƒˆåŒ– */
btnDoText.addEventListener("click", ()=>{
  closeExportModal();
  doTextExport();
});

/* ä¸Šéƒ¨ï¼ˆé¸æŠãƒ¢ãƒ¼ãƒ‰ï¼‰ã®ãƒ†ã‚­ã‚¹ãƒˆåŒ–ï¼šç›´æ¥å®Ÿè¡Œ */
btnSelText.addEventListener("click", ()=>{
  doTextExport();
});

/* Import */
btnImport.addEventListener("click", ()=>{
  fileImport.value = "";
  fileImport.click();
});

fileImport.addEventListener("change", async ()=>{
  const files = Array.from(fileImport.files || []);
  if (!files.length) return;

  const jsonFile = files.find(f => (f.name||"").toLowerCase().endsWith(".json"));
  if (jsonFile){
    if (!confirm("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ç¾åœ¨ã®ãƒ¡ãƒ¢ã‚’å…¨ã¦ç½®ãæ›ãˆã¾ã™ã€‚\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
    try{
      const text = await jsonFile.text();
      const obj = safeParse(text, null);
      if (!obj || !obj.data) throw new Error("invalid");
      store = normalizeStore(obj.data);
      ensureAtLeastOne();
      saveStore();
      toast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
      setSelectionMode(false);
      showList();
    }catch(e){
      alert("ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šJSONå½¢å¼ãŒä¸æ­£ã‹å£Šã‚Œã¦ã¾ã™");
    }
    return;
  }

  const txtFiles = files.filter(f => (f.name||"").toLowerCase().endsWith(".txt"));
  if (!txtFiles.length){
    alert("å¯¾å¿œå½¢å¼ï¼š.json / .txt");
    return;
  }

  for (const f of txtFiles){
    const text = await f.text();
    const body = escapeHtml(text).replace(/\r?\n/g, "<br>");
    const title = (f.name||"").replace(/\.txt$/i,"") || "ç„¡é¡Œ";
    const n = { id: uid(), title, bodyHtml: body, createdAt: nowTs(), updatedAt: nowTs() };
    store.notes.unshift(n);
    store.normalOrderIds = store.normalOrderIds.filter(x=>x!==n.id);
    store.normalOrderIds.unshift(n.id);
  }

  saveStore();
  renderList();
  toast(`.txt ã‚’${txtFiles.length}ä»¶å–ã‚Šè¾¼ã¿ã¾ã—ãŸ`);
});

/* Drag */
let dragState = null;

function attachManualDrag(handleEl, rowEl, note){
  const HOLD_MS = 220;
  let timer = null;

  const start = (e)=>{
    if ((elSearch.value||"").trim()) return;
    if (selectionMode) return;
    e.preventDefault();
    e.stopPropagation();

    timer = setTimeout(()=>{
      beginDrag(rowEl, note);

      document.addEventListener("touchmove", onDragMove, {passive:false});
      document.addEventListener("touchend", onDragEnd);
      document.addEventListener("pointermove", onDragMove);
      document.addEventListener("pointerup", onDragEnd);
    }, HOLD_MS);
  };

  const cancel = ()=>{
    clearTimeout(timer);
    timer = null;
  };

  handleEl.addEventListener("touchstart", start, {passive:false});
  handleEl.addEventListener("touchend", cancel);
  handleEl.addEventListener("touchmove", cancel);

  handleEl.addEventListener("pointerdown", start);
  handleEl.addEventListener("pointerup", cancel);
  handleEl.addEventListener("pointercancel", cancel);
}

function beginDrag(rowEl, note){
  const pinned = isPinned(note.id);

  const ghost = document.createElement("div");
  ghost.className = "ghost";
  ghost.style.height = rowEl.getBoundingClientRect().height + "px";

  rowEl.after(ghost);
  rowEl.classList.add("dragging");

  dragState = { rowEl, note, ghost, pinned };
  toast("ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ");
}

function onDragMove(e){
  if (!dragState) return;
  if (e.cancelable) e.preventDefault();

  const y = (e.touches && e.touches[0]) ? e.touches[0].clientY : e.clientY;

  const rows = Array.from(notesEl.querySelectorAll(".rowCompact"))
    .filter(el => el !== dragState.rowEl)
    .filter(el => {
      const id = el.dataset.id;
      return dragState.pinned ? isPinned(id) : !isPinned(id);
    });

  let target = null;
  for (const r of rows){
    const rect = r.getBoundingClientRect();
    const mid = rect.top + rect.height/2;
    if (y < mid){ target = r; break; }
  }

  if (target){
    notesEl.insertBefore(dragState.ghost, target);
  }else{
    const last = rows[rows.length-1];
    if (last) last.after(dragState.ghost);
  }
}

function onDragEnd(){
  if (!dragState) return;

  document.removeEventListener("touchmove", onDragMove);
  document.removeEventListener("touchend", onDragEnd);
  document.removeEventListener("pointermove", onDragMove);
  document.removeEventListener("pointerup", onDragEnd);

  dragState.rowEl.classList.remove("dragging");
  dragState.ghost.replaceWith(dragState.rowEl);

  const ids = Array.from(notesEl.querySelectorAll(".rowCompact")).map(el=>el.dataset.id);

  if (dragState.pinned){
    store.pinnedIds = ids.filter(id=>isPinned(id));
  }else{
    store.normalOrderIds = ids.filter(id=>!isPinned(id));
  }

  saveStore();
  dragState = null;
  renderList();
  toast("ä¸¦ã³æ›¿ãˆã¾ã—ãŸ");
}

/* hardware back */
window.addEventListener("popstate", ()=>{
  const inEdit = !screenEdit.classList.contains("hidden");
  if (!inEdit) return;

  if (!confirmDiscardIfDirty()){
    history.pushState({screen:"edit", id: currentId}, "");
    return;
  }
  showList();
});
window.addEventListener("beforeunload", (e)=>{
  if (!dirty) return;
  e.preventDefault();
  e.returnValue = "";
});

/* Update modal */
let waitingSW = null;
function openUpdateModal(sw){
  waitingSW = sw || null;
  updateModalBg.classList.add("show");
}
function closeUpdateModal(){ updateModalBg.classList.remove("show"); }

btnReloadLater.addEventListener("click", ()=> closeUpdateModal());
btnReloadNow.addEventListener("click", ()=>{
  if (!screenEdit.classList.contains("hidden") && dirty){
    const ok = confirm("æœªä¿å­˜ãŒã‚ã‚Šã¾ã™ã€‚å†èµ·å‹•ã™ã‚‹ã¨æœªä¿å­˜ã¯æ¶ˆãˆã¾ã™ã€‚\nç¶šã‘ã¾ã™ã‹ï¼Ÿ");
    if (!ok) return;
  }
  closeUpdateModal();
  if (waitingSW) waitingSW.postMessage({type:"SKIP_WAITING"});
  else location.reload();
});
updateModalBg.addEventListener("click", (e)=>{ if (e.target === updateModalBg) closeUpdateModal(); });

/* boot */
function boot(){
  ensureAtLeastOne();
  saveStore();
  renderList();
  updateTopActions();
  history.replaceState({screen:"list"}, "");
}
boot();

/* SW register */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", async () => {
    try{
      const reg = await navigator.serviceWorker.register("./sw.js", { updateViaCache: "none" });

      if (reg.waiting && navigator.serviceWorker.controller){
        openUpdateModal(reg.waiting);
      }

      reg.addEventListener("updatefound", ()=>{
        const sw = reg.installing;
        if (!sw) return;
        sw.addEventListener("statechange", ()=>{
          if (sw.state === "installed" && navigator.serviceWorker.controller){
            toast("æ›´æ–°ã‚ã‚Š");
            openUpdateModal(sw);
          }
        });
      });

      navigator.serviceWorker.addEventListener("controllerchange", ()=> location.reload());
      setInterval(()=>{ reg.update().catch(()=>{}); }, 60 * 60 * 1000);
    }catch(_){}
  });
}
</script>
</body>
</html>